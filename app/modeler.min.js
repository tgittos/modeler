var MJS_VERSION=0,MJS_DO_ASSERT=!0,MJS_FLOAT_ARRAY_TYPE=Array,MathUtils_assert=MJS_DO_ASSERT?function(a,b){if(!a)throw"Assertion failed: "+b;}:function(){},V3={};V3._temp1=new MJS_FLOAT_ARRAY_TYPE(3);V3._temp2=new MJS_FLOAT_ARRAY_TYPE(3);V3._temp3=new MJS_FLOAT_ARRAY_TYPE(3);
MJS_FLOAT_ARRAY_TYPE==Array?(V3.x=[1,0,0],V3.y=[0,1,0],V3.z=[0,0,1],V3.$=function(a,b,c){return[a,b,c]},V3.clone=function(a){return[a[0],a[1],a[2]]}):(V3.x=new MJS_FLOAT_ARRAY_TYPE([1,0,0]),V3.y=new MJS_FLOAT_ARRAY_TYPE([0,1,0]),V3.z=new MJS_FLOAT_ARRAY_TYPE([0,0,1]),V3.$=function(a,b,c){return new MJS_FLOAT_ARRAY_TYPE([a,b,c])},V3.clone=function(a){return new MJS_FLOAT_ARRAY_TYPE(a)});V3.u=V3.x;V3.v=V3.y;
V3.add=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];return c};V3.sub=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c};V3.neg=function(a,b){b==void 0&&(b=new MJS_FLOAT_ARRAY_TYPE(3));b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];return b};V3.direction=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));return V3.normalize(V3.sub(a,b,c),c)};
V3.length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])};V3.lengthSquared=function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]};V3.normalize=function(a,b){b==void 0&&(b=new MJS_FLOAT_ARRAY_TYPE(3));var c=1/V3.length(a);b[0]=a[0]*c;b[1]=a[1]*c;b[2]=a[2]*c;return b};V3.scale=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c};V3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};
V3.cross=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));c[0]=a[1]*b[2]-a[2]*b[1];c[1]=a[2]*b[0]-a[0]*b[2];c[2]=a[0]*b[1]-a[1]*b[0];return c};V3.mul4x4=function(a,b,c){var d,e=V3._temp1;c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));e[0]=a[3];e[1]=a[7];e[2]=a[11];d=V3.dot(b,e)+a[15];e[0]=a[0];e[1]=a[4];e[2]=a[8];c[0]=(V3.dot(b,e)+a[12])/d;e[0]=a[1];e[1]=a[5];e[2]=a[9];c[1]=(V3.dot(b,e)+a[13])/d;e[0]=a[2];e[1]=a[6];e[2]=a[10];c[2]=(V3.dot(b,e)+a[14])/d;return c};var M4x4={};M4x4._temp1=new MJS_FLOAT_ARRAY_TYPE(16);
M4x4._temp2=new MJS_FLOAT_ARRAY_TYPE(16);
MJS_FLOAT_ARRAY_TYPE==Array?(M4x4.I=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],M4x4.$=function(a,b,c,d,e,g,f,h,i,j,k,l,o,p,m,n){return[a,b,c,d,e,g,f,h,i,j,k,l,o,p,m,n]},M4x4.clone=function(a){return new [a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]}):(M4x4.I=new MJS_FLOAT_ARRAY_TYPE([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),M4x4.$=function(a,b,c,d,e,g,f,h,i,j,k,l,o,p,m,n){return new MJS_FLOAT_ARRAY_TYPE([a,b,c,d,e,g,f,h,i,j,k,l,o,p,m,n])},M4x4.clone=function(a){return new MJS_FLOAT_ARRAY_TYPE(a)});
M4x4.identity=M4x4.I;M4x4.topLeft3x3=function(a,b){b==void 0&&(b=new MJS_FLOAT_ARRAY_TYPE(9));b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[4];b[4]=a[5];b[5]=a[6];b[6]=a[8];b[7]=a[9];b[8]=a[10];return b};M4x4.inverseOrthonormal=function(a,b){b==void 0&&(b=new MJS_FLOAT_ARRAY_TYPE(16));M4x4.transpose(a,b);var c=[a[12],a[13],a[14]];b[3]=b[7]=b[11]=0;b[12]=-V3.dot([b[0],b[4],b[8]],c);b[13]=-V3.dot([b[1],b[5],b[9]],c);b[14]=-V3.dot([b[2],b[6],b[10]],c);return b};
M4x4.inverseTo3x3=function(a,b){b==void 0&&(b=new MJS_FLOAT_ARRAY_TYPE(9));var c=a[10]*a[5]-a[6]*a[9],d=-a[10]*a[1]+a[2]*a[9],e=a[6]*a[1]-a[2]*a[5],g=-a[10]*a[4]+a[6]*a[8],f=a[10]*a[0]-a[2]*a[8],h=-a[6]*a[0]+a[2]*a[4],i=a[9]*a[4]-a[5]*a[8],j=-a[9]*a[0]+a[1]*a[8],k=a[5]*a[0]-a[1]*a[4],l=a[0]*c+a[1]*g+a[2]*i;if(l==0)throw"matrix not invertible";l=1/l;b[0]=l*c;b[1]=l*d;b[2]=l*e;b[3]=l*g;b[4]=l*f;b[5]=l*h;b[6]=l*i;b[7]=l*j;b[8]=l*k;return b};
M4x4.makeFrustum=function(a,b,c,d,e,g,f){f==void 0&&(f=new MJS_FLOAT_ARRAY_TYPE(16));f[0]=2*e/(b-a);f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2*e/(d-c);f[6]=0;f[7]=0;f[8]=(b+a)/(b-a);f[9]=(d+c)/(d-c);f[10]=-(g+e)/(g-e);f[11]=-1;f[12]=0;f[13]=0;f[14]=-2*g*e/(g-e);f[15]=0;return f};M4x4.makePerspective=function(a,b,c,d,e){var a=c*Math.tan(a*Math.PI/360),g=-a;return M4x4.makeFrustum(g*b,a*b,g,a,c,d,e)};
M4x4.makeOrtho=function(a,b,c,d,e,g,f){f==void 0&&(f=new MJS_FLOAT_ARRAY_TYPE(16));f[0]=2/(b-a);f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/(d-c);f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/(g-e);f[11]=0;f[12]=-(b+a)/(b-a);f[13]=-(d+c)/(d-c);f[14]=-(g+e)/(g-e);f[15]=1;return f};M4x4.makeOrtho2D=function(a,b,c,d,e){return M4x4.makeOrtho(a,b,c,d,-1,1,e)};
M4x4.mul=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(16));var d=a[0],e=a[1],g=a[2],f=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],o=a[9],p=a[10],m=a[11],n=a[12],q=a[13],s=a[14],a=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],b=b[15];c[0]=d*t+h*u+l*v+n*w;c[1]=e*t+i*u+o*v+q*w;c[2]=g*t+j*u+p*v+s*w;c[3]=f*t+k*u+m*v+a*w;c[4]=d*x+h*y+l*z+n*A;c[5]=e*x+i*y+o*z+q*A;c[6]=g*x+j*y+p*z+s*A;c[7]=f*x+k*y+m*z+a*A;c[8]=d*B+h*C+l*D+n*E;c[9]=
e*B+i*C+o*D+q*E;c[10]=g*B+j*C+p*D+s*E;c[11]=f*B+k*C+m*D+a*E;c[12]=d*F+h*G+l*H+n*b;c[13]=e*F+i*G+o*H+q*b;c[14]=g*F+j*G+p*H+s*b;c[15]=f*F+k*G+m*H+a*b;return c};
M4x4.mulOffset=function(a,b,c,d){var e=a[1],g=a[2],f=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],o=a[9],p=a[10],m=a[11],n=a[12],q=a[13],s=a[14],a=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],b=b[15];c[d+0]=a11*t+h*u+l*v+n*w;c[d+1]=e*t+i*u+o*v+q*w;c[d+2]=g*t+j*u+p*v+s*w;c[d+3]=f*t+k*u+m*v+a*w;c[d+4]=a11*x+h*y+l*z+n*A;c[d+5]=e*x+i*y+o*z+q*A;c[d+6]=g*x+j*y+p*z+s*A;c[d+7]=f*x+k*y+m*z+a*A;c[d+8]=a11*B+h*C+l*D+n*E;c[d+9]=e*B+i*C+o*D+q*E;
c[d+10]=g*B+j*C+p*D+s*E;c[d+11]=f*B+k*C+m*D+a*E;c[d+12]=a11*F+h*G+l*H+n*b;c[d+13]=e*F+i*G+o*H+q*b;c[d+14]=g*F+j*G+p*H+s*b;c[d+15]=f*F+k*G+m*H+a*b;return c};
M4x4.mulAffine=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(16));var d=a[0],e=a[1],g=a[2],f=a[4],h=a[5],i=a[6],j=a[8],k=a[9],l=a[10],o=a[12],p=a[13],a=a[14],m=b[0],n=b[1],q=b[2],s=b[4],t=b[5],u=b[6],v=b[8],w=b[9],x=b[10],y=b[12],z=b[13],b=b[14];c[0]=d*m+f*n+j*q;c[1]=e*m+h*n+k*q;c[2]=g*m+i*n+l*q;c[3]=0;c[4]=d*s+f*t+j*u;c[5]=e*s+h*t+k*u;c[6]=g*s+i*t+l*u;c[7]=0;c[8]=d*v+f*w+j*x;c[9]=e*v+h*w+k*x;c[10]=g*v+i*w+l*x;c[11]=0;c[12]=d*y+f*z+j*b+o;c[13]=e*y+h*z+k*b+p;c[14]=g*y+i*z+l*b+a;c[15]=1;return c};
M4x4.mulAffine=function(a,b,c,d){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(16));var e=a[0],g=a[1],f=a[2],h=a[4],i=a[5],j=a[6],k=a[8],l=a[9],o=a[10],p=a[12],m=a[13],a=a[14],n=b[0],q=b[1],s=b[2],t=b[4],u=b[5],v=b[6],w=b[8],x=b[9],y=b[10],z=b[12],A=b[13],b=b[14];c[d+0]=e*n+h*q+k*s;c[d+1]=g*n+i*q+l*s;c[d+2]=f*n+j*q+o*s;c[d+3]=0;c[d+4]=e*t+h*u+k*v;c[d+5]=g*t+i*u+l*v;c[d+6]=f*t+j*u+o*v;c[d+7]=0;c[d+8]=e*w+h*x+k*y;c[d+9]=g*w+i*x+l*y;c[d+10]=f*w+j*x+o*y;c[d+11]=0;c[d+12]=e*z+h*A+k*b+p;c[d+13]=g*z+i*A+l*b+m;
c[d+14]=f*z+j*A+o*b+a;c[d+15]=1;return c};M4x4.makeRotate=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(16));var b=V3.normalize(b,V3._temp1),d=b[0],e=b[1],b=b[2],g=Math.cos(a),f=1-g,a=Math.sin(a);c[0]=d*d*f+g;c[1]=e*d*f+b*a;c[2]=b*d*f-e*a;c[3]=0;c[4]=d*e*f-b*a;c[5]=e*e*f+g;c[6]=e*b*f+d*a;c[7]=0;c[8]=d*b*f+e*a;c[9]=e*b*f-d*a;c[10]=b*b*f+g;c[11]=0;c[12]=0;c[13]=0;c[14]=0;c[15]=1;return c};
M4x4.rotate=function(a,b,c,d){d==void 0&&(d=new MJS_FLOAT_ARRAY_TYPE(16));var e=b[0],g=b[1],f=b[2],b=Math.sqrt(e*e+g*g+f*f),h=e,e=g,g=f;b!=1&&(b=1/b,h*=b,e*=b,g*=b);var b=Math.cos(a),f=1-b,a=Math.sin(a),i=h*a,j=e*a,k=g*a,l=h*e*f,o=h*g*f,p=e*g*f,a=c[0],m=c[1],n=c[2],q=c[3],s=c[4],t=c[5],u=c[6],v=c[7],w=c[8],x=c[9],y=c[10],z=c[11],h=h*h*f+b,A=l+k,B=o-j,k=l-k,e=e*e*f+b,l=p+i,j=o+j,i=p-i,g=g*g*f+b;d[0]=a*h+s*A+w*B;d[1]=m*h+t*A+x*B;d[2]=n*h+u*A+y*B;d[3]=q*h+v*A+z*B;d[4]=a*k+s*e+w*l;d[5]=m*k+t*e+x*l;d[6]=
n*k+u*e+y*l;d[7]=q*k+v*e+z*l;d[8]=a*j+s*i+w*g;d[9]=m*j+t*i+x*g;d[10]=n*j+u*i+y*g;d[11]=q*j+v*i+z*g;d!=c&&(d[12]=c[12],d[13]=c[13],d[14]=c[14],d[15]=c[15]);return d};M4x4.makeScale3=function(a,b,c,d){d==void 0&&(d=new MJS_FLOAT_ARRAY_TYPE(16));d[0]=a;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=b;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=c;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return d};M4x4.makeScale1=function(a,b){return M4x4.makeScale3(a,a,a,b)};
M4x4.makeScale=function(a,b){return M4x4.makeScale3(a[0],a[1],a[2],b)};M4x4.scale3=function(a,b,c,d,e){if(e==d)return d[0]*=a,d[1]*=a,d[2]*=a,d[3]*=a,d[4]*=b,d[5]*=b,d[6]*=b,d[7]*=b,d[8]*=c,d[9]*=c,d[10]*=c,d[11]*=c,d;e==void 0&&(e=new MJS_FLOAT_ARRAY_TYPE(16));e[0]=d[0]*a;e[1]=d[1]*a;e[2]=d[2]*a;e[3]=d[3]*a;e[4]=d[4]*b;e[5]=d[5]*b;e[6]=d[6]*b;e[7]=d[7]*b;e[8]=d[8]*c;e[9]=d[9]*c;e[10]=d[10]*c;e[11]=d[11]*c;e[12]=d[12];e[13]=d[13];e[14]=d[14];e[15]=d[15];return e};
M4x4.scale1=function(a,b,c){if(c==b)return b[0]*=a,b[1]*=a,b[2]*=a,b[3]*=a,b[4]*=a,b[5]*=a,b[6]*=a,b[7]*=a,b[8]*=a,b[9]*=a,b[10]*=a,b[11]*=a,b;c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(16));c[0]=b[0]*a;c[1]=b[1]*a;c[2]=b[2]*a;c[3]=b[3]*a;c[4]=b[4]*a;c[5]=b[5]*a;c[6]=b[6]*a;c[7]=b[7]*a;c[8]=b[8]*a;c[9]=b[9]*a;c[10]=b[10]*a;c[11]=b[11]*a;c[12]=b[12];c[13]=b[13];c[14]=b[14];c[15]=b[15];return c};
M4x4.scale=function(a,b,c){var d=a[0],e=a[1],a=a[2];if(c==b)return b[0]*=d,b[1]*=d,b[2]*=d,b[3]*=d,b[4]*=e,b[5]*=e,b[6]*=e,b[7]*=e,b[8]*=a,b[9]*=a,b[10]*=a,b[11]*=a,b;c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(16));c[0]=b[0]*d;c[1]=b[1]*d;c[2]=b[2]*d;c[3]=b[3]*d;c[4]=b[4]*e;c[5]=b[5]*e;c[6]=b[6]*e;c[7]=b[7]*e;c[8]=b[8]*a;c[9]=b[9]*a;c[10]=b[10]*a;c[11]=b[11]*a;c[12]=b[12];c[13]=b[13];c[14]=b[14];c[15]=b[15];return c};
M4x4.makeTranslate3=function(a,b,c,d){d==void 0&&(d=new MJS_FLOAT_ARRAY_TYPE(16));d[0]=1;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=1;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=1;d[11]=0;d[12]=a;d[13]=b;d[14]=c;d[15]=1;return d};M4x4.makeTranslate1=function(a,b){return M4x4.makeTranslate3(a,a,a,b)};M4x4.makeTranslate=function(a,b){return M4x4.makeTranslate3(a[0],a[1],a[2],b)};
M4x4.translate3Self=function(a,b,c,d){d[12]+=d[0]*a+d[4]*b+d[8]*c;d[13]+=d[1]*a+d[5]*b+d[9]*c;d[14]+=d[2]*a+d[6]*b+d[10]*c;d[15]+=d[3]*a+d[7]*b+d[11]*c;return d};
M4x4.translate3=function(a,b,c,d,e){if(e==d)return d[12]+=d[0]*a+d[4]*b+d[8]*c,d[13]+=d[1]*a+d[5]*b+d[9]*c,d[14]+=d[2]*a+d[6]*b+d[10]*c,d[15]+=d[3]*a+d[7]*b+d[11]*c,d;e==void 0&&(e=new MJS_FLOAT_ARRAY_TYPE(16));var g=d[0],f=d[1],h=d[2],i=d[3],j=d[4],k=d[5],l=d[6],o=d[7],p=d[8],m=d[9],n=d[10],q=d[11];e[0]=g;e[1]=f;e[2]=h;e[3]=i;e[4]=j;e[5]=k;e[6]=l;e[7]=o;e[8]=p;e[9]=m;e[10]=n;e[11]=q;e[12]=g*a+j*b+p*c+d[12];e[13]=f*a+k*b+m*c+d[13];e[14]=h*a+l*b+n*c+d[14];e[15]=i*a+o*b+q*c+d[15];return e};
M4x4.translate1=function(a,b,c){return M4x4.translate3(a,a,a,b,c)};M4x4.translateSelf=function(a,b){var c=a[0],d=a[1],e=a[2];b[12]+=b[0]*c+b[4]*d+b[8]*e;b[13]+=b[1]*c+b[5]*d+b[9]*e;b[14]+=b[2]*c+b[6]*d+b[10]*e;b[15]+=b[3]*c+b[7]*d+b[11]*e;return b};
M4x4.translate=function(a,b,c){var d=a[0],e=a[1],a=a[2];if(c==b)return b[12]+=b[0]*d+b[4]*e+b[8]*a,b[13]+=b[1]*d+b[5]*e+b[9]*a,b[14]+=b[2]*d+b[6]*e+b[10]*a,b[15]+=b[3]*d+b[7]*e+b[11]*a,b;c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(16));var g=b[0],f=b[1],h=b[2],i=b[3],j=b[4],k=b[5],l=b[6],o=b[7],p=b[8],m=b[9],n=b[10],q=b[11];c[0]=g;c[1]=f;c[2]=h;c[3]=i;c[4]=j;c[5]=k;c[6]=l;c[7]=o;c[8]=p;c[9]=m;c[10]=n;c[11]=q;c[12]=g*d+j*e+p*a+b[12];c[13]=f*d+k*e+m*a+b[13];c[14]=h*d+l*e+n*a+b[14];c[15]=i*d+o*e+q*a+b[15];
return c};
M4x4.makeLookAt=function(a,b,c,d){var b=V3.direction(a,b,V3._temp1),c=V3.normalize(V3.cross(c,b,V3._temp2),V3._temp2),e=V3.normalize(V3.cross(b,c,V3._temp3),V3._temp3),g=M4x4._temp1,f=M4x4._temp2;g[0]=c[0];g[1]=e[0];g[2]=b[0];g[3]=0;g[4]=c[1];g[5]=e[1];g[6]=b[1];g[7]=0;g[8]=c[2];g[9]=e[2];g[10]=b[2];g[11]=0;g[12]=0;g[13]=0;g[14]=0;g[15]=1;f[0]=1;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=1;f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=1;f[11]=0;f[12]=-a[0];f[13]=-a[1];f[14]=-a[2];f[15]=1;d==void 0&&(d=new MJS_FLOAT_ARRAY_TYPE(16));return M4x4.mul(g,
f,d)};M4x4.transposeSelf=function(a){var b=a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[3];a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return a};
M4x4.transpose=function(a,b){if(a==b){var c=0,c=a[1];a[1]=a[4];a[4]=c;c=a[2];a[2]=a[8];a[8]=c;c=a[3];a[3]=a[12];a[12]=c;c=a[6];a[6]=a[9];a[9]=c;c=a[7];a[7]=a[13];a[13]=c;c=a[11];a[11]=a[14];a[14]=c;return a}b==void 0&&(b=new MJS_FLOAT_ARRAY_TYPE(16));b[0]=a[0];b[1]=a[4];b[2]=a[8];b[3]=a[12];b[4]=a[1];b[5]=a[5];b[6]=a[9];b[7]=a[13];b[8]=a[2];b[9]=a[6];b[10]=a[10];b[11]=a[14];b[12]=a[3];b[13]=a[7];b[14]=a[11];b[15]=a[15];return b};
M4x4.transformPoint=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));var d=b[0],e=b[1],b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];a=a[3]*d+a[7]*e+a[11]*b+a[15];a!=1&&(c[0]/=a,c[1]/=a,c[2]/=a);return c};
M4x4.transformLine=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));var d=b[0],e=b[1],b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b;c[1]=a[1]*d+a[5]*e+a[9]*b;c[2]=a[2]*d+a[6]*e+a[10]*b;a=a[3]*d+a[7]*e+a[11]*b;a!=1&&(c[0]/=a,c[1]/=a,c[2]/=a);return c};M4x4.transformPointAffine=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));var d=b[0],e=b[1],b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c};
M4x4.transformLineAffine=function(a,b,c){c==void 0&&(c=new MJS_FLOAT_ARRAY_TYPE(3));var d=b[0],e=b[1],b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b;c[1]=a[1]*d+a[5]*e+a[9]*b;c[2]=a[2]*d+a[6]*e+a[10]*b;return c};M4x3={make4x4:function(a){console.log("M4x3.make4x4");r=[];r[0]=a[0];r[1]=a[1];r[2]=a[2];r[3]=1;r[4]=a[3];r[5]=a[4];r[6]=a[5];r[7]=1;r[8]=a[6];r[9]=a[7];r[10]=a[8];r[11]=1;r[12]=a[9];r[13]=a[10];r[14]=a[11];r[15]=1;return r}};M3x3={make4x4:function(a){console.log("M3x3.make4x4");r=[];r[0]=a[0];r[1]=a[1];r[2]=a[2];r[3]=1;r[4]=a[3];r[5]=a[4];r[6]=a[5];r[7]=1;r[8]=a[6];r[9]=a[7];r[10]=a[8];r[11]=1;r[12]=r[13]=r[14]=r[15]=1;return r}};
M4x4.left4x3=function(a){console.log("M4x4.left4x3");r=[];r[0]=a[0];r[1]=a[1];r[2]=a[2];r[3]=a[4];r[4]=a[5];r[5]=a[6];r[6]=a[8];r[7]=a[9];r[8]=a[10];r[9]=a[12];r[10]=a[13];r[11]=a[14];return r};Array.prototype.contains=function(a){for(var b=0;b<this.length;b++)if(equals(a,this[b]))return!0;return!1};Array.prototype.each=function(a){for(var b=0;b<this.length;b++)a.call(this[b],b)};Array.prototype.remove=function(a){for(var b=0;b<this.length;b++)if(equals(a,this[b])){this.splice(b,1);break}};
if(!Array.prototype.indexOf)Array.prototype.indexOf=function(a){if(this===void 0||this===null)throw new TypeError;var b=Object(this),c=b.length>>>0;if(c===0)return-1;var d=0;arguments.length>0&&(d=Number(arguments[1]),d!==d?d=0:d!==0&&d!==1/0&&d!==-(1/0)&&(d=(d>0||-1)*Math.floor(Math.abs(d))));if(d>=c)return-1;for(d=d>=0?d:Math.max(c-Math.abs(d),0);d<c;d++)if(d in b&&b[d]===a)return d;return-1};
Array.prototype.inspect=function(){var a="[",b=[];this.each(function(){typeof this.inspect==="function"?b.push(this.inspect.call(this)):b.push(this)});a+=b.join(", ");return a+"]"};Array.prototype.join=function(a){var b="";this.each(function(){b+=this+a});return b.substr(0,b.length-2)};Math.degreesToRadians=function(a){return Math.PI*(a/180)};window.assert=function(a,b){if(!a)throw b||"Assert was false";};
if(!window.requestAnimationFrame)window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();
window.equals=function(a,b){if(a===b)return!0;var c=typeof a;if(c!=typeof b)return!1;if(a==b)return!0;if(!a&&b||a&&!b)return!1;if(a.isEqual)return a.isEqual(b);if(isDate(a)&&isDate(b))return a.getTime()===b.getTime();if(isNaN(a)&&isNaN(b))return!1;if(isRegExp(a)&&isRegExp(b))return a.source===b.source&&a.global===b.global&&a.ignoreCase===b.ignoreCase&&a.multiline===b.multiline;if(c!=="object")return!1;if(a.length&&a.length!==b.length)return!1;var c=keys(a),d=keys(b);if(c.length!=d.length)return!1;
for(var e in a)if(!(e in b)||!equals(a[e],b[e]))return!1;return!0};window.isRegExp=function(a){return!(!a||!a.test||!a.exec||!(a.ignoreCase||a.ignoreCase===!1))};window.isDate=function(a){return!(!a||!a.getTime||!a.getTimezoneOffset||!a.setUTCFullYear)};window.isNaN=function(a){return a!==a};window.keys=Object.keys||function(a){var b=[],c;for(c in a)hasOwnProperty.call(a,c)&&(b[b.length]=c);return b};var MODELER=MODELER||{};MODELER.IO=MODELER.IO||{};MODELER.Keyboard=MODELER.Keyboard||{};MODELER.webGLContextString="experimental-webgl";(function(){try{window.canvas=document.createElement("canvas"),window.gl=canvas.getContext(MODELER.webGLContextString)}catch(a){}if(!gl)throw"Could not initialize WebGL. Does your browser support it?";})();MODELER.Event=function(){var a={},b={};a.listen=function(a,d,e){b[a]||(b[a]=[]);b[a].push({handler:d,expires:e})};a.dispatch=function(a,d){b[a]&&b[a].each(function(){var e=this.handler;this.expires&&b[a].remove(this);e.call(this,{event:a,data:d})})};a.stopListening=function(a,d){b[a]&&b[a].each(function(){this.handler==d&&b[a].remove(this)})};a.reset=function(){b={}};return a}();
MODELER.EVENTS={SYNCLOADER:{LOAD_SUCCESS:"MODELER:EVENTS:SYNCLOADER:LOAD_SUCCESS",LOAD_FAILURE:"MODELER:EVENTS:SYNCLOADER:LOAD_FAILURE"},ASYNCLOADER:{LOAD_SUCCESS:"MODELER:EVENTS:ASYNCLOADER:LOAD_SUCCESS",LOAD_FAILURE:"MODELER:EVENTS:ASYNCLOADER:LOAD_FAILURE"},SHADER:{PROGRAM_LOADED:"MODELER:EVENTS:SHADER:PROGRAM_LOADED"},MATERIAL:{MATERIAL_LOADED:"MODELER:EVENTS:MATERIAL:MATERIAL_LOADED"},TEXTURE:{TEXTURE_LOADED:"MODELER:EVENTS:TEXTURE:TEXTURE_LOADED"},KEYBOARD:{W:87,A:65,S:83,D:68}};MODELER.Keyboard.Listener=function(){var a,b=[];a={};document.addEventListener("keydown",function(a){b.each(function(){this.call(this,a)})},!0);a.start=function(a){b.push(a)};a.stop=function(a){b.remove(a)};return a}();MODELER.IO.SyncLoader=function(){var a={},b=0,c=0,d=[],e={PARTIAL_SUCCESS:"MODELER.LOADER.PRIVATE_EVENTS.PARTIAL_SUCCESS",PARTIAL_FAILURE:"MODELER.LOADER.PRIVATE_EVENTS.PARTIAL_FAILURE"},g=function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0);c.onreadystatechange=function(){c.readyState==4&&(c.status==200?MODELER.Event.dispatch(e.PARTIAL_SUCCESS,{response:c.responseText,data:b}):MODELER.Event.dispatch(e.PARTIAL_FAILURE,a))};c.send(null)},f=function(a){d[a.data.data]=a.data.response;c++;c==b&&
(MODELER.Event.stopListening(e.PARTIAL_SUCCESS,f),MODELER.Event.stopListening(e.PARTIAL_FAILURE,h),MODELER.Event.dispatch(MODELER.EVENTS.SYNCLOADER.LOAD_SUCCESS,d))},h=function(){MODELER.Event.dispatch(MODELER.EVENTS.SYNCLOADER.LOAD_FAILURE,urls)};a.loadFiles=function(a){b=a.length;c=0;MODELER.Event.listen(e.PARTIAL_SUCCESS,f);MODELER.Event.listen(e.PARTIAL_FAILURE,h);for(var d=0;d<b;d++)g(a[d],d)};return a}();MODELER.Vertex=function(a,b,c){return[a,b,c]};MODELER.Face3=function(a,b){var c,b=b||{},d=[],e=[],g=[],f=function(){var a=[];b.vertices.each(function(){a=a.concat(this)});return a},h=function(){var a=[];b.elements.each(function(){a.push(this[0],this[1],this[2])});return a},i=function(){var a=[];b.lines.each(function(){a=a.concat(this)});return a};c={};if(a.vertices)d=a.vertices,e=[[0,1,2]],g=[[0,1],[1,2],[2,0]];b.vertices=d;b.elements=e;b.lines=g;b.convertTo4x4=function(a){return M3x3.make4x4(a)};b.ensure=function(){b.vertices=M4x4.topLeft3x3(b.vertices)};
c.rotate=function(a){a=M4x4.makeRotate(Math.degreesToRadians(a.degrees),a.axis);console.log(a);console.log(b.vertices);b.vertices=M4x4.mul(a,b.convertTo4x4(b.vertices));console.log(b.vertices);b.ensure();console.log(b.vertices);return this};c.translate=function(a){a=M4x4.makeTranslate([a.x||0,a.y||0,a.z||0]);console.log(a);console.log(b.vertices);b.vertices=M4x4.mul(a,b.convertTo4x4(b.vertices));b.ensure();console.log(b.vertices);return this};c.inspect=function(){var a="{";a+="vertices: "+b.vertices.inspect()+
", ";var c=[];a+="elements: [";b.elements.each(function(){c.push(this.inspect())});a+=c.join(", ");a+="], ";var d=[];a+="lines: [";b.lines.each(function(){d.push(this.inspect())});a+=d.join(", ");a+="]";return a+="}"};c.getForRender=function(){return{vertices:f(),elementIndices:h(),lines:i()}};return c};MODELER.Face4=function(a,b){var c,b={};c=MODELER.Face3(a,b);b.convertTo4x4=function(a){return M4x3.make4x4(a)};b.ensure=function(){b.vertices=M4x4.left4x3(b.vertices)};b.elements.push([0,2,3]);b.lines=[[0,1],[1,2],[2,3],[3,0]];return c};MODELER.Geometry=function(a){var b=[];a||(a={});a.faces&&(b=b.concat(a.faces));return{createFace3:function(a){assert(a.width&&a.height,"dimensions are required for a face3");a=MODELER.Face3({vertices:[a.width/-2,a.height/-2,0,0,a.height/2,0,a.width/2,a.height/-2,0]});b.push(a);return a},setFace3s:function(a,d){for(var e=0;e<d.length;e+=3){var g=MODELER.Face3({vertices:[a[d[e]],a[d[e+1]],a[d[e+2]]]});b.push(g)}},createFace4:function(a){assert(a.width&&a.height,"dimensions are required for a face4");
a=MODELER.Face4({vertices:[a.width/-2,a.height/-2,0,a.width/2,a.height/-2,0,a.width/2,a.height/2,0,a.width/-2,a.height/2,0]});b.push(a);return a},inspect:function(){var a="{";a+="faces: [";var d=[];b.each(function(){d.push(this.inspect())});a+=d.join(", ");return a+="]}"},getForRender:function(){var a=[],d=[],e=[];b.each(function(){var b=this.getForRender(),f=a.length>0?a.length/3:0;b.elementIndices.each(function(){d.push(f+this)});b.lines.each(function(){e.push(f+this)});a=a.concat(b.vertices)});
return{vertices:a,elementIndices:d,lines:e}}}};MODELER.Mesh=function(a){var b,c={},d=[],e={};b={};(function(){a.each(function(){if(this.name&&this.geometry){var a=this.name;if(c[a])throw"Geometry group with name "+a+" already exists";c[a]=this.geometry}if(this.material)a=this.material,d.contains(a)||d.push(a),a=d.indexOf(this.material),e[this.name]=a})})();b.getForRender=function(){var a=[],b;for(b in c){var h=c[b].getForRender();a.push({vertices:h.vertices,elementIndices:h.elementIndices,lines:h.lines,material:d[e[b]]})}return a};return b};MODELER.Primitive=function(a,b){var c,b=b||{},d=V3.y;c={};b.mesh=null;b.x=0;b.y=0;b.z=0;b.rotVector=d;b.rotDegrees=0;c.x=b.x;c.y=b.y;c.z=b.z;c.rotVector=b.rotVector;c.rotDegrees=b.rotDegrees;c.getForRender=function(){return b.mesh.getForRender()};c.getMeshes=function(){return[b.mesh]};return c};MODELER.Cube=function(a){var b,c=null,d=0,e=0,g=0,f=0,h=0,i=0,j=null,k=0;(function(){if(a.width)f=a.width;if(a.height)h=a.height;if(a.depth)i=a.depth;if(a.x)d=a.x;if(a.y)e=a.y;if(a.z)g=a.z;if(a.rotVector)j=a.rotVector;if(a.rotDegrees)k=a.rotDegrees;var b=MODELER.Geometry();b.createFace4({width:f,height:h}).translate({z:i/2});b.createFace4({width:f,height:h}).rotate({degrees:90,axis:V3.y}).translate({x:f/-2});b.createFace4({width:f,height:h}).rotate({degrees:180,axis:V3.y}).translate({z:f/-2});b.createFace4({width:f,
height:h}).rotate({degrees:270,axis:V3.y}).translate({x:f/2});b.createFace4({width:f,height:h}).rotate({degrees:90,axis:V3.x}).translate({y:f/2});b.createFace4({width:f,height:h}).rotate({degrees:-90,axis:V3.x}).translate({y:f/-2});c=MODELER.Mesh([{name:"cube",geometry:b,material:a.material}])})();b={getMeshes:function(){return[c]},getForRender:function(){return c.getForRender()}};b.x=d;b.y=e;b.z=g;b.rotDegrees=k;b.rotVector=j;return b};MODELER.Pyramid=function(a){var b,c=null,d=0,e=0,g=0,f=0,h=0;rotVector=V3.x;rotDegrees=0;b={};(function(){if(a.height)f=a.height;if(a.depth)h=a.depth;if(a.x)d=a.x;if(a.y)e=a.y;if(a.z)g=a.z;if(a.rotVector)rotVector=a.rotVector;if(a.rotDegrees)rotDegrees=a.rotDegrees;var b={width:2,height:2,depth:2},j=f/-2-f/-2*0.866025404,k=MODELER.Geometry();k.createFace4(b).rotate({degrees:90,axis:V3.x}).translate({y:f/-2});k.createFace3(b).rotate({degrees:-30,axis:V3.x}).translate({y:j,z:h/2*0.5});k.createFace3(b).rotate({degrees:90,
axis:V3.y}).rotate({degrees:30,axis:V3.z}).translate({y:j,x:h/2*0.5});k.createFace3(b).rotate({degrees:30,axis:V3.x}).translate({y:j,z:h/-2*0.5});k.createFace3(b).rotate({degrees:-90,axis:V3.y}).rotate({degrees:-30,axis:V3.z}).translate({y:j,x:h/-2*0.5});c=MODELER.Mesh([{name:"pyramid",geometry:k,material:a.material}])})();b.getMeshes=function(){return[c]};b.getForRender=function(){return c.getForRender()};b.x=d;b.y=e;b.z=g;b.rotDegrees=rotDegrees;b.rotVector=rotVector;return b};MODELER.Plane=function(a){var b,c=null,d=0,e=0,g=0,f=0,h=0,i=null,j=0;b={};f=a.width||2;h=a.height||2;d=a.x||0;e=a.y||0;g=a.z||0;i=a.rotVector||[0,0,0];j=a.rotDegrees||0;(function(){var b=MODELER.Geometry();b.createFace4({width:f,height:h});c=MODELER.Mesh([{name:"plane",geometry:b,material:a.material}])})();b.getMeshes=function(){return[c]};b.getForRender=function(){return c.getForRender()};b.x=d;b.y=e;b.z=g;b.rotDegrees=j;b.rotVector=i;return b};MODELER.Sphere=function(a,b){var c,b=b||{},d=8,e=8,g=2;c=MODELER.Primitive(a,b);d=a.longitudes||d;e=a.latitudes||e;g=a.radius||g;(function(){for(var c=[],h=[],i=0;i<=e;i++)for(var j=i*Math.PI/e,k=Math.sin(j),l=Math.cos(j),j=0;j<d;j++){var o=j*2*Math.PI/d,p=l,m=Math.sin(o)*k;c.push(g*Math.cos(o)*k);c.push(g*p);c.push(g*m)}for(i=0;i<e;i++)for(j=0;j<d;j++)k=i*(d+1)+j,l=k+d+1,h.push(k),h.push(l),h.push(k+1),h.push(l),h.push(l+1),h.push(k+1);i=MODELER.Geometry();i.setFace3s(c,h);b.mesh=MODELER.Mesh([{name:"sphere",
geometry:i,material:a.material}])})();return c};MODELER.Scene=function(){var a=[],b=0;return{addChild:function(c){assert(c,"No object given");assert(typeof c.getForRender==="function","Not a renderable object");if(!a.contains(c))c.id="Object"+b++,a.push(c);return!0},removeChild:function(b){assert(b,"No object given");assert(typeof b.getForRender==="function","Not a renderable object");if(a.contains(b))return a.remove(b),!0;return!1},hasChild:function(b){assert(b,"No object given");assert(typeof b.getForRender==="function","Not a renderable object");
return a.contains(b)},getChildren:function(){return a}}};MODELER.Camera=function(a){var b,c=null,d=null,e=null,g=null,f=0,h=0,i=0;b={};a=a||{};a.fov=a.fov||45;a.ratio=a.ratio||800/600;a.nearClip=a.nearClip||0.1;a.farClip=a.farClip||100;if(a.fov)c=a.fov;if(a.ratio)d=a.ratio;if(a.nearClip)e=a.nearClip;if(a.farClip)g=a.farClip;if(a.x)f=a.x;if(a.y)h=a.y;if(a.z)i=a.z;b.getFov=function(){return c};b.getRatio=function(){return d};b.getNearClip=function(){return e};b.getFarClip=function(){return g};b.x=f;b.y=h;b.z=i;return b};MODELER.Object3D=function(a){var b,c=[],d=0,e=0,g=0,f=null,h=0;b={};if(a.meshes)c=a.meshes;if(a.x)d=a.x;if(a.y)e=a.y;if(a.z)g=a.z;if(a.rotVector)f=a.rotVector;if(a.rotDegrees)h=a.rotDegrees;b.x=d;b.y=e;b.z=g;b.rotVector=f;b.rotDegrees=h;b.getForRender=function(){var a=[],b=[],d=[],e=null;c.each(function(){var c=this.getForRender();a=a.concat(c.vertices);b=b.concat(c.elementIndices);d=d.concat(c.lines);e=c.material});return{vertices:a,elementIndices:b,lines:d,material:e}};b.getMeshes=function(){return c};
b.inspect=function(){var a="{";a+="meshes: "+c.inspect();return a+"}"};return b};MODELER.Object3D.VertexSize=3;MODELER.Object3D.ColourSize=4;MODELER.Shader={};MODELER.Shader.Type={Fragment:"x-shader/x-fragment",Vertex:"x-shader/x-vertex"};var REDBACK={Core:{},Materials:{},Shaders:{},Textures:{}};MODELER.Materials=MODELER.Materials||{};REDBACK.Core.WebGLRenderer=function(a){var b,c=800,d=600,e=null,g=null,f=!1,h=function(a,b){c=a||c;d=b||d;canvas.width=c;canvas.height=d;gl.viewportWidth=canvas.width;gl.viewportHeight=canvas.height},i=function(a,b,c){assert(typeof a.getForRender==="function","Not a renderable object");a.getForRender().each(function(){this.material.setupShaderProgram(this.vertices);var a=this.material.getShaderProgram();gl.useProgram(a);var d=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,d);gl.bufferData(gl.ARRAY_BUFFER,
new Float32Array(this.vertices),gl.STATIC_DRAW);gl.vertexAttribPointer(a.vertexPositionAttribute,MODELER.Object3D.VertexSize,gl.FLOAT,!1,0,0);gl.uniformMatrix4fv(a.pMatrixUniform,!1,new Float32Array(b));gl.uniformMatrix4fv(a.mvMatrixUniform,!1,new Float32Array(c));this.material.alpha<1?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.enable(gl.BLEND),gl.disable(gl.DEPTH_TEST)):(gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL));this.material.wireframe&&(this.material.setDrawMode(REDBACK.Enum.DRAW_MODE.WIREFRAME),
gl.lineWidth(this.material.wireframe_width),a=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,a),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.lines),gl.STATIC_DRAW),gl.drawElements(gl.LINES,this.lines.length,gl.UNSIGNED_SHORT,0));if(!this.material.wireframe||this.material.wireframe&&this.material.wireframe_mode==REDBACK.Enum.WIREFRAME_MODE.BOTH)this.material.setDrawMode(REDBACK.Enum.DRAW_MODE.TEXTURE),a=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,a),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,
new Uint16Array(this.elementIndices),gl.STATIC_DRAW),gl.drawElements(gl.TRIANGLES,this.elementIndices.length,gl.UNSIGNED_SHORT,0)})};b={};if(gl)document.body.appendChild(canvas),h(),e=a.scene,g=a.camera,gl.clearColor(0,0,0,1),gl.clearDepth(1);b.setSize=h;b.render=function(){gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);var a=M4x4.makePerspective(g.getFov(),g.getRatio(),g.getNearClip(),g.getFarClip()),b=M4x4.translate(V3.$(g.x,g.y,g.z),M4x4.I);
f||console.log("camera pos matrix: "+b.inspect());f||console.log("perspective matrix: "+a.inspect());for(var c=e.getChildren(),d=0;d<c.length;d++){var h=c[d],m=M4x4.translate(V3.$(h.x,h.y,h.z),b);f||console.log("translation matrix: "+m.inspect());var n=M4x4.rotate(Math.degreesToRadians(h.rotDegrees),h.rotVector,m);f||console.log("rotation matrix: "+n.inspect());m=M4x4.mul(m,n);f||console.log("vertex matrix: "+m.inspect());f=!0;i(h,a,m)}};return b};REDBACK.Enum=REDBACK.Enums||{};REDBACK.Enum.WIREFRAME_MODE={WIREFRAME_ONLY:0,BOTH:1};REDBACK.Enum.DRAW_MODE={WIREFRAME:0,TEXTURE:1};REDBACK.Materials.WebGLMaterial=function(a,b){var c,b=b||{},d=!1,e=[0.5,0.5,0.5,1],g=REDBACK.Enum.WIREFRAME_MODE.WIREFRAME_ONLY,f=2,h=null,i=function(a){var b=[];a.each(function(){b=b.concat(e)});h=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,h);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(b),gl.STATIC_DRAW)},j=function(a){a==REDBACK.Enum.DRAW_MODE.WIREFRAME&&k(b.shaderProgram.vertexColorAttribute,h,MODELER.Object3D.ColourSize)},k=function(a,b,c){gl.bindBuffer(gl.ARRAY_BUFFER,b);gl.vertexAttribPointer(a,
c,gl.FLOAT,!1,0,0)};c={};b.wireframe=d;b.wireframe_colour=e;b.wireframe_mode=g;b.wireframe_width=f;b.shaderProgram=null;b.edge_colour_buffer=h;b.setupShaderProgram=i;b.setDrawMode=j;b.pointShaderToArray=k;(function(){if(a.wireframe)d=a.wireframe;if(a.wireframe_mode)g=a.wireframe_mode;if(a.wireframe_width)f=a.wireframe_width;if(!a.shaders)a.shaders={};a.shaders.fragmentShader&&a.shaders.vertexShader&&(REDBACK.Shaders.WebGLShader({fragmentShader:a.shaders.fragmentShader,vertexShader:a.shaders.vertexShader}).getShaderProgram(),
MODELER.Event.listen(MODELER.EVENTS.SHADER.PROGRAM_LOADED,function(a){b.shaderProgram=a.data;b.initShaderProgram();MODELER.Event.dispatch(MODELER.EVENTS.MATERIAL.MATERIAL_LOADED,b.shaderProgram)},!0))})();c.wireframe=d;c.wireframe_mode=g;c.wireframe_width=f;c.getShaderProgram=function(){return b.shaderProgram};c.setupShaderProgram=i;c.setDrawMode=j;c.inspect=function(){var a="{";a+="colour: "+colour.inspect();a+=", wireframe: "+d;return a+"}"};return c};REDBACK.Materials.WebGLSolidColourMaterial=function(a,b){var c,b=b||{},d=[1,1,1,1],e=null,g=function(a){var b=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,b);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(a),gl.STATIC_DRAW);return b};a.shaders={fragmentShader:"../src/shaders/webglcolour.fshader",vertexShader:"../src/shaders/webglcolour.vshader"};c=REDBACK.Materials.WebGLMaterial(a,b);b.initShaderProgram=function(){b.shaderProgram.vertexPositionAttribute=gl.getAttribLocation(b.shaderProgram,"aVertexPosition");
gl.enableVertexAttribArray(b.shaderProgram.vertexPositionAttribute);b.shaderProgram.vertexColorAttribute=gl.getAttribLocation(b.shaderProgram,"aVertexColor");gl.enableVertexAttribArray(b.shaderProgram.vertexColorAttribute);b.shaderProgram.pMatrixUniform=gl.getUniformLocation(b.shaderProgram,"uPMatrix");b.shaderProgram.mvMatrixUniform=gl.getUniformLocation(b.shaderProgram,"uMVMatrix")};if(a.colour)d=a.colour;c.colour=d;c.setupShaderProgram=function(a){var c=[],i=[];a.each(function(){c=c.concat(d);
i=i.concat(b.wireframe_colour)});e=g(c);b.edge_colour_buffer=g(i)};c.setDrawMode=function(a){if(a==REDBACK.Enum.DRAW_MODE.WIREFRAME){var a=shaderProgram.vertexColorAttribute,c=MODELER.Object3D.ColourSize;gl.bindBuffer(gl.ARRAY_BUFFER,b.edge_colour_buffer)}else a=shaderProgram.vertexColorAttribute,c=MODELER.Object3D.ColourSize,gl.bindBuffer(gl.ARRAY_BUFFER,e);gl.vertexAttribPointer(a,c,gl.FLOAT,!1,0,0)};return c};REDBACK.Materials.WebGLTextureMaterial=function(a,b){var c,b=b||{},d=1,e=null,g=[];a.shaders={fragmentShader:"../src/shaders/webgltexture.fshader",vertexShader:"../src/shaders/webgltexture.vshader"};c=REDBACK.Materials.WebGLMaterial(a,b);b.initShaderProgram=function(){b.shaderProgram.textureCoordAttribute=gl.getAttribLocation(b.shaderProgram,"aTextureCoord");gl.enableVertexAttribArray(b.shaderProgram.textureCoordAttribute);b.shaderProgram.vertexPositionAttribute=gl.getAttribLocation(b.shaderProgram,
"aVertexPosition");gl.enableVertexAttribArray(b.shaderProgram.vertexPositionAttribute);b.shaderProgram.samplerUniform=gl.getUniformLocation(b.shaderProgram,"uSampler");b.shaderProgram.alphaUniform=gl.getUniformLocation(b.shaderProgram,"uAlpha");b.shaderProgram.pMatrixUniform=gl.getUniformLocation(b.shaderProgram,"uPMatrix");b.shaderProgram.mvMatrixUniform=gl.getUniformLocation(b.shaderProgram,"uMVMatrix")};if(a.texture)e=a.texture;if(a.alpha)d=a.alpha;c.setupShaderProgram=function(a){for(var a=a.length/
4,b=0;b<a;b++)g.push(0,0,0,1,1,1,1,0)};c.setDrawMode=function(a){a!=REDBACK.Enum.DRAW_MODE.WIREFRAME&&(a=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,a),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(g),gl.STATIC_DRAW),b.pointShaderToArray(b.shaderProgram.textureCoordAttribute,a,2),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e),gl.uniform1i(b.shaderProgram.samplerUniform,0),gl.uniform1f(b.shaderProgram.alphaUniform,d))};c.alpha=d;return c};REDBACK.Shaders.WebGLShader=function(a){var b,c=null,d=null,e=null,g=null,f=null,h=null,i=function(a){MODELER.Event.stopListening(MODELER.EVENTS.SYNCLOADER.LOAD_FAILURE,j);f=a.data[0];h=a.data[1];c=k(f,MODELER.Shader.Type.Vertex);d=k(h,MODELER.Shader.Type.Fragment);shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,c);gl.attachShader(shaderProgram,d);gl.linkProgram(shaderProgram);gl.getProgramParameter(shaderProgram,gl.LINK_STATUS)||alert("Could not initialise shaders: ",gl.getProgramInfoLog(shaderProgram));
MODELER.Event.dispatch(MODELER.EVENTS.SHADER.PROGRAM_LOADED,shaderProgram)},j=function(){MODELER.Event.stopListening(MODELER.EVENTS.SYNCLOADER.LOAD_SUCCESS,i);alert("failed to load ",url)},k=function(a,b){var c;if(b==MODELER.Shader.Type.Fragment)c=gl.createShader(gl.FRAGMENT_SHADER);else if(b==MODELER.Shader.Type.Vertex)c=gl.createShader(gl.VERTEX_SHADER);else return null;gl.shaderSource(c,a);gl.compileShader(c);if(!gl.getShaderParameter(c,gl.COMPILE_STATUS))return alert(gl.getShaderInfoLog(c)),null;
return c};b={};if(!a.vertexShader)a.vertexShader={};if(!a.fragmentShader)a.fragmentShader={};if(a.vertexShader)e=a.vertexShader;if(a.fragmentShader)g=a.fragmentShader;b.getShaderProgram=function(){MODELER.Event.listen(MODELER.EVENTS.SYNCLOADER.LOAD_SUCCESS,i,!0);MODELER.Event.listen(MODELER.EVENTS.SYNCLOADER.LOAD_FAILURE,j,!0);MODELER.IO.SyncLoader.loadFiles([e,g])};return b};REDBACK.Textures.WebGLTexture=function(a){var b,c=null,d=null;b={};a||(a={});if(a.src)c=a.src;d=gl.createTexture();d.image=new Image;d.image.onload=function(){gl.bindTexture(gl.TEXTURE_2D,d);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,d.image);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,
null);MODELER.Event.dispatch(MODELER.EVENTS.TEXTURE.TEXTURE_LOADED,d)};d.image.src=c;b.getTexture=function(){return d};return b};
